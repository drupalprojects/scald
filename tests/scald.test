<?php
/**
 * @file
 * Tests for scald.module.
 */

/**
 * Defines a base class for testing the Scald module.
 */
class ScaldWebTestCase extends DrupalWebTestCase {
  function setUp() {
    $modules = func_get_args();
    if (isset($modules[0]) && is_array($modules[0])) {
      $modules = $modules[0];
    }
    $modules[] = 'scald';
    parent::setUp($modules);

    // Create Article node type.
    if ($this->profile != 'standard') {
      $this->drupalCreateContentType(array('type' => 'article', 'name' => 'Article'));
    }
  }
}

/**
 * Test the Scald base functionality.
 */
class ScaldBaseTestCase extends ScaldWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'Scald base',
      'description' => 'Test the Scald base functionality.',
      'group' => 'Scald',
    );
  }

  function testScaldBaseAtomType() {
    module_enable(array('scald_audio'));

    $web_user = $this->drupalCreateUser(array('create article content', 'create page content', 'view any atom', 'fetch any atom'));
    $this->drupalLogin($web_user);

    $default = scald_atom_defaults('audio');
    $this->assertEqual($default->thumbnail_source, 'public://atoms/audio.png', 'Default thumbnail for audios set correctly.');
    $this->assertTrue(file_exists($default->thumbnail_source), 'Default thumbnail for audios exists.');
  }

  /**
   * Test Scald admin.
   */
  function testScaldAdmin() {
    $web_user = $this->drupalCreateUser(array(
    ));
    $this->drupalLogin($web_user);
    $this->drupalGet('admin/structure/scald');
    $this->assertResponse(403, 'Normal user cannot administer Scald');
    $this->drupalLogout();

    $admin_user = $this->drupalCreateUser(array(
      'administer scald',
    ));
    $this->drupalLogin($admin_user);
    $this->drupalGet('admin/structure/scald');
    $this->assertResponse(200, 'Admin user can administer Scald');
  }

  /**
   * Test Scald context.
   */
  function testScaldContext() {
    module_enable(array('scald_image'));

    // Prefix to avoid invalid names.
    $title = 'context' . $this->randomName(10);
    $name = strtolower($title);
    $description = $this->randomName(20);

    $web_user = $this->drupalCreateUser(array(
      'administer scald',
    ));
    $this->drupalLogin($web_user);

    $this->drupalGet('admin/structure/scald');
    $this->clickLink('Add context');
    $edit = array(
      'title' => $title,
      // There is no JavaScript in the SimpleBrowser, thus machine name must be
      // filled manually.
      'name' => $name,
      'description' => $description,
    );
    $this->drupalPost(NULL, $edit, t('Add context'));

    $this->assertText($title, 'Context created.');
    $this->assertText($description, 'Context description is correct.');
    $this->assertLinkByHref('admin/structure/scald/context/edit/' . $name, 0, 'New context can be edited.');

    $this->clickLink('contexts');
    $edit = array(
      'full_trans' => 'style-large',
      $name . '_trans' => 'style-thumbnail',
      $name . '_playe' => 'image_figure',
    );
    $this->drupalPost(NULL, $edit, t('Save'));
    $this->assertField('full_trans', 'style-large', 'Context transcoder updated.');
    $this->assertField($name . '_playe', 'image_figure', 'Context player updated.');

    // Player settings.
    $this->clickLink('settings');
    $class = 'class-' . $this->randomName(5);
    $caption = '//[atom:title]//';
    $edit = array(
      'classes' => $class,
      'caption' => $caption,
    );
    $this->drupalPost(NULL, $edit, t('Update'));

    // Verify new context settings.

  }
}

/**
 * Test the Scald atom entities.
 */
class ScaldAtomEntityTestCase extends ScaldWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'Scald atom entities',
      'description' => 'Test the Scald atom entities.',
      'group' => 'Scald',
    );
  }

  function setUp() {
    parent::setUp('scald_image');
    $web_user = $this->drupalCreateUser(array('create article content', 'create page content', 'create atom of image type', 'view any atom', 'fetch any atom'));
    $this->drupalLogin($web_user);
  }

  function createAtom() {
    $files = $this->drupalGetTestFiles('image');
    $image = reset($files);
    $edit = array();
    $edit['files[file]'] = drupal_realpath($image->uri);
    $this->drupalPost('atom/add/image', $edit, t('Continue'));
    $this->assertFieldByName('atom0[title]', $image->filename);
    $this->drupalPost(NULL, array(), t('Finish'));

    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'scald_atom');
    $query->propertyCondition('type', 'image');
    $result = $query->execute();
    $this->assertEqual(count($result['scald_atom']), 1, 'Image atom has been created.');
  }

  /**
   * Create four nodes and ensure they're loaded correctly.
   */
  function testScaldAtomCRUD() {
    $this->createAtom();
    $atom = scald_atom_load(1);

    $this->assertTrue($atom->fetched, 'Image atom has been loaded.');
  }

  /**
   * Permission tests.
   */
  function testScaldAtomPermissions() {
    $this->createAtom();
    $atom = scald_atom_load(1);

    // Try to view the atom.
    $this->drupalGet('atom/' . $atom->sid);
    $this->assertTitle($atom->title . ' | Drupal', 'Image atom can be accessed.');

    // User without permission.
    $web_user = $this->drupalCreateUser(array('fetch any atom'));
    $this->drupalLogin($web_user);
    $this->drupalGet('atom/' . $atom->sid);
    $this->assertResponse(403);
    $this->drupalLogout();
    $this->drupalGet('atom/' . $atom->sid);
    $this->assertResponse(404);
  }
}
